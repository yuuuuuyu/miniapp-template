# miniprogram-ci å¢å¼ºç‰ˆ

åŸºäºå¾®ä¿¡å®˜æ–¹ miniprogram-ci çš„å¢å¼ºç‰ˆæœ¬ï¼Œæä¾›æ›´ä¾¿æ·çš„å°ç¨‹åºå¼€å‘å’Œéƒ¨ç½²å·¥å…·ã€‚

## åŠŸèƒ½ç‰¹æ€§

- âœ… **é¢„è§ˆåŠŸèƒ½**: æ”¯æŒäº¤äº’å¼å’Œéäº¤äº’å¼é¢„è§ˆ
- âœ… **ä¸Šä¼ åŠŸèƒ½**: è‡ªåŠ¨ç‰ˆæœ¬ç®¡ç†ï¼ŒGitæäº¤ä¿¡æ¯ä½œä¸ºæè¿°
- âœ… **æ„å»ºnpm**: å¯¹åº”å¼€å‘è€…å·¥å…·çš„æ„å»ºnpmåŠŸèƒ½
- âœ… **é¡µé¢ç®¡ç†**: å¿«é€Ÿåˆ›å»ºå’Œåˆ é™¤å°ç¨‹åºé¡µé¢
- âœ… **é…ç½®ç®¡ç†**: çµæ´»çš„é…ç½®æ–‡ä»¶æ”¯æŒ
- âœ… **ç¯å¢ƒæ”¯æŒ**: æ”¯æŒå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒé…ç½®
- âœ¨ **è§„èŒƒåŒ–æ—¥å¿—**: æ”¯æŒå¤šç§æ›´æ–°æ—¥å¿—æ ¼å¼ï¼ˆç®€å•/è¯¦ç»†/å˜æ›´æ—¥å¿—ï¼‰
- âœ¨ **æ™ºèƒ½æ ¼å¼åŒ–**: è‡ªåŠ¨æŒ‰æäº¤ç±»å‹åˆ†ç»„ï¼Œç”Ÿæˆä¸“ä¸šçš„ç‰ˆæœ¬è¯´æ˜

## å®‰è£…

```bash
npm install
```

## é…ç½®

1. å¤åˆ¶ `ci.config.js` å¹¶æ ¹æ®é¡¹ç›®å®é™…æƒ…å†µä¿®æ”¹é…ç½®
2. ä»å¾®ä¿¡å…¬ä¼—å¹³å°ä¸‹è½½ç§é’¥æ–‡ä»¶ï¼Œæ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹
3. é…ç½®IPç™½åå•ï¼ˆæ¨èï¼‰

## ä½¿ç”¨æ–¹æ³•

### é¡µé¢ç®¡ç†

å¿«é€Ÿåˆ›å»ºå’Œåˆ é™¤å°ç¨‹åºé¡µé¢ï¼Œè‡ªåŠ¨ç”Ÿæˆé¡µé¢æ–‡ä»¶å¹¶æ›´æ–° `app.json` é…ç½®ã€‚

#### åˆ›å»ºé¡µé¢

åˆ›å»ºä¸€ä¸ªæ–°çš„å°ç¨‹åºé¡µé¢ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š
- `xxx.ts` - é¡µé¢é€»è¾‘ï¼ˆåŒ…å«å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼‰
- `xxx.json` - é¡µé¢é…ç½®
- `xxx.wxml` - é¡µé¢æ¨¡æ¿
- `xxx.scss` - é¡µé¢æ ·å¼

```bash
# ä½¿ç”¨npmè„šæœ¬
npm run create-page my-page

# ç›´æ¥ä½¿ç”¨CLI
node cli/index.js create-page user-profile
```

æ‰§è¡Œåä¼šï¼š
1. åœ¨ `miniprogram/pages/` ä¸‹åˆ›å»ºé¡µé¢ç›®å½•å’Œæ–‡ä»¶
2. è‡ªåŠ¨åœ¨ `app.json` çš„ `pages` æ•°ç»„ï¿½ï¿½ï¿½æ·»åŠ é¡µé¢è·¯å¾„
3. æ˜¾ç¤ºåˆ›å»ºç»“æœå’Œæ–‡ä»¶åˆ—è¡¨

#### åˆ é™¤é¡µé¢

åˆ é™¤æŒ‡å®šçš„å°ç¨‹åºé¡µé¢ï¼Œä¼šè‡ªåŠ¨æ¸…ç†ç›¸å…³æ–‡ä»¶å¹¶æ›´æ–°é…ç½®ã€‚

```bash
# ä½¿ç”¨npmè„šæœ¬ï¼ˆäº¤äº’å¼ç¡®è®¤ï¼‰
npm run delete-page my-page

# ç›´æ¥ä½¿ç”¨CLIï¼ˆäº¤äº’å¼ç¡®è®¤ï¼‰
node cli/index.js delete-page user-profile

# å¼ºåˆ¶åˆ é™¤ï¼Œä¸éœ€è¦ç¡®è®¤
node cli/index.js delete-page my-page --force
node cli/index.js delete-page my-page -f
```

æ‰§è¡Œåä¼šï¼š
1. åˆ é™¤æ•´ä¸ªé¡µé¢ç›®å½•åŠæ‰€æœ‰æ–‡ä»¶
2. è‡ªåŠ¨ä» `app.json` çš„ `pages` æ•°ç»„ä¸­ç§»é™¤é¡µé¢è·¯å¾„
3. æ˜¾ç¤ºåˆ é™¤ç»“æœå’Œå·²åˆ é™¤çš„æ–‡ä»¶åˆ—è¡¨

**æ³¨æ„äº‹é¡¹ï¼š**
- é¡µé¢åç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œä¸­åˆ’çº¿
- é»˜è®¤ä¼šè¦æ±‚ç¡®è®¤åˆ é™¤æ“ä½œï¼Œä½¿ç”¨ `--force` å¯è·³è¿‡ç¡®è®¤
- åˆ é™¤æ“ä½œä¸å¯æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œ

### æ„å»ºnpm

æ„å»ºnpmåŒ…ï¼Œå¯¹åº”å¾®ä¿¡å¼€å‘è€…å·¥å…·çš„"å·¥å…· -> æ„å»ºnpm"åŠŸèƒ½ã€‚

```bash
# ä½¿ç”¨npmè„šæœ¬
npm run build-npm

# ç›´æ¥ä½¿ç”¨CLI
node cli/index.js build-npm

# æ˜¾ç¤ºè¯¦ç»†æ„å»ºä¿¡æ¯
node cli/index.js build-npm --verbose

# æ’é™¤ç‰¹å®šæ–‡ä»¶
node cli/index.js build-npm --ignores "test/**/*,docs/**/*"
```

#### æ„å»ºnpmå‚æ•°è¯´æ˜

miniprogram-ciçš„æ„å»ºnpmåŠŸèƒ½æ”¯æŒä¸‰ä¸ªé‡è¦å‚æ•°ï¼š

1. **project** (å¿…å¡«): é¡¹ç›®å¯¹è±¡ï¼ŒåŒ…å«appidã€é¡¹ç›®è·¯å¾„ã€ç§é’¥ç­‰ä¿¡æ¯
2. **options.ignores** (å¯é€‰): æŒ‡å®šæ„å»ºnpmæ—¶éœ€è¦æ’é™¤çš„è§„åˆ™ï¼Œæ”¯æŒglobæ¨¡å¼
3. **options.reporter** (å¯é€‰): æ„å»ºè¿‡ç¨‹çš„å›è°ƒå‡½æ•°ï¼Œç”¨äºæ¥æ”¶æ„å»ºä¿¡æ¯

#### æ™ºèƒ½æ„å»ºæ¨¡å¼

æœ¬å·¥å…·ä¼šè‡ªåŠ¨æ£€æµ‹é¡¹ç›®é…ç½®ï¼š

- **æ‰‹åŠ¨æ„å»ºæ¨¡å¼**: å¦‚æœ `project.config.json` ä¸­è®¾ç½®äº† `packNpmManually: true` å’Œ `packNpmRelationList`ï¼Œå°†ä½¿ç”¨ `ci.packNpmManually` æ–¹æ³•
- **æ ‡å‡†æ„å»ºæ¨¡å¼**: å¦åˆ™ä½¿ç”¨æ ‡å‡†çš„ `ci.packNpm` æ–¹æ³•

è¿™æ ·å¯ä»¥é€‚åº”ä¸åŒçš„é¡¹ç›®ç»“æ„ï¼Œç‰¹åˆ«æ˜¯å½“ `node_modules` ä¸åœ¨å°ç¨‹åºç›®å½•ä¸‹æ—¶ã€‚

#### é…ç½®æ–‡ä»¶ä¸­çš„æ„å»ºnpmé€‰é¡¹

åœ¨ `ci.config.js` ä¸­å¯ä»¥é…ç½®é»˜è®¤çš„æ„å»ºnpmé€‰é¡¹ï¼š

```javascript
buildNpm: {
    ignores: [], // æ„å»ºnpmæ—¶éœ€è¦æ’é™¤çš„è§„åˆ™
    verbose: false // æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†æ„å»ºä¿¡æ¯
}
```

### é¢„è§ˆåŠŸèƒ½

```bash
# äº¤äº’å¼é¢„è§ˆï¼ˆé»˜è®¤ï¼‰
npm run preview

# éäº¤äº’å¼é¢„è§ˆ
node cli/index.js preview --no-interactive --qrcode-format terminal
```

### ä¸Šä¼ åŠŸèƒ½

```bash
# è‡ªåŠ¨é€’å¢ç‰ˆæœ¬å·ä¸Šä¼ 
npm run upload

# æŒ‡å®šç‰ˆæœ¬å·ä¸Šä¼ 
node cli/index.js upload --version 1.0.1

# è‡ªå®šä¹‰æè¿°å’Œæœºå™¨äºº
node cli/index.js upload --desc "æ‰‹åŠ¨æŒ‡å®šçš„æè¿°" --robot 2
```

#### æ›´æ–°æ—¥å¿—æ ¼å¼ ğŸ†•

æ”¯æŒä¸‰ç§æ›´æ–°æ—¥å¿—æ ¼å¼ï¼Œè®©ç‰ˆæœ¬æè¿°æ›´åŠ è§„èŒƒï¼š

```bash
# ç®€å•æ ¼å¼ï¼šåªæ˜¾ç¤ºæœ€æ–°æäº¤
node cli/index.js upload --desc-format simple

# è¯¦ç»†æ ¼å¼ï¼šæ˜¾ç¤ºæœ€è¿‘å‡ æ¡æäº¤ï¼ˆé»˜è®¤ï¼‰
node cli/index.js upload --desc-format detailed --commit-count 5

# å˜æ›´æ—¥å¿—æ ¼å¼ï¼šæŒ‰ç±»å‹åˆ†ç»„æ˜¾ç¤ºï¼ˆæ¨èï¼‰
node cli/index.js upload --desc-format changelog

# è‡ªå®šä¹‰å‚æ•°
node cli/index.js upload \
  --desc-format changelog \
  --commit-count 8 \
  --desc-max-length 400 \
  --no-include-hash
```

**æ ¼å¼æ•ˆæœé¢„è§ˆï¼š**

```bash
# æŸ¥çœ‹ä¸åŒæ ¼å¼çš„æ•ˆæœæ¼”ç¤º
npm run demo:changelog
```

è¯¦ç»†é…ç½®è¯´æ˜è¯·å‚è€ƒï¼š[æ›´æ–°æ—¥å¿—æ ¼å¼é…ç½®æŒ‡å—](docs/CHANGELOG_FORMATS.md)

## å‘½ä»¤è¡Œé€‰é¡¹

### é€šç”¨é€‰é¡¹
- `--interactive` / `--no-interactive`: å¯ç”¨/ç¦ç”¨äº¤äº’æ¨¡å¼
- `--help`: æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯

### é¡µé¢ç®¡ç†é€‰é¡¹
- `create-page <name>`: åˆ›å»ºæ–°é¡µé¢ï¼ˆé¡µé¢åç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œä¸­åˆ’çº¿ï¼‰
- `delete-page <name>`: åˆ é™¤é¡µé¢
- `--force` / `-f`: å¼ºåˆ¶åˆ é™¤é¡µé¢ï¼Œä¸éœ€è¦ç¡®è®¤ï¼ˆä»…ç”¨äº delete-pageï¼‰

### æ„å»ºnpmé€‰é¡¹
- `--ignores <patterns>`: æŒ‡å®šéœ€è¦æ’é™¤çš„è§„åˆ™ï¼ˆé€—å·åˆ†éš”ï¼‰
- `--verbose`: æ˜¾ç¤ºè¯¦ç»†æ„å»ºä¿¡æ¯

### é¢„è§ˆé€‰é¡¹
- `--desc <string>`: é¢„è§ˆæè¿°
- `--qrcode-format <type>`: äºŒç»´ç æ ¼å¼ (image|terminal)
- `--qrcode-output <path>`: äºŒç»´ç è¾“å‡ºè·¯å¾„
- `--page-path <path>`: é¢„è§ˆé¡µé¢è·¯å¾„
- `--search-query <query>`: é¢„è§ˆå‚æ•°
- `--scene <number>`: åœºæ™¯å€¼

### ä¸Šä¼ é€‰é¡¹
- `--version <string>`: ç‰ˆæœ¬å·
- `--desc <string>`: ä¸Šä¼ æè¿°
- `--robot <number>`: CIæœºå™¨äººç¼–å· (1-30)
- `--increment-type <type>`: ç‰ˆæœ¬é€’å¢ç±»å‹ (major|minor|patch)
- `--no-auto-increment`: ç¦ç”¨è‡ªåŠ¨ç‰ˆæœ¬é€’å¢
- `--desc-format <type>`: æè¿°æ ¼å¼ (simple|detailed|changelog)
- `--commit-count <number>`: è·å–æäº¤è®°å½•æ•°é‡
- `--desc-max-length <number>`: æè¿°æœ€å¤§é•¿åº¦
- `--no-include-hash`: ä¸åŒ…å«æäº¤å“ˆå¸Œå€¼

## ç¯å¢ƒå˜é‡

- `NODE_ENV`: ç¯å¢ƒ (development|staging|production)
- `VERSION`: ç‰ˆæœ¬å·
- `ROBOT`: æœºå™¨äººç¼–å·
- `APPID`: å°ç¨‹åº AppID
- `DEBUG`: è°ƒè¯•æ¨¡å¼

## æ³¨æ„äº‹é¡¹

1. æ„å»ºnpmå‰è¯·ç¡®ä¿é¡¹ç›®ä¸­å­˜åœ¨ `package.json` å’Œ `node_modules` ç›®å½•
2. æ„å»ºnpmä¼šç”Ÿæˆ `miniprogram_npm` ç›®å½•ï¼Œä½ç½®å–å†³äºé…ç½®
3. å¦‚æœæ„å»ºè¿‡ç¨‹ä¸­å‡ºç°è­¦å‘Šï¼Œè¯·æ£€æŸ¥ç›¸å…³çš„npmåŒ…æ˜¯å¦æ­£ç¡®å®‰è£…
4. å»ºè®®åœ¨ä¸Šä¼ å‰å…ˆæ‰§è¡Œæ„å»ºnpmï¼Œç¡®ä¿ç¬¬ä¸‰æ–¹åŒ…èƒ½æ­£å¸¸ä½¿ç”¨

## æ„å»ºä½ç½®é…ç½®

ä¸ºäº†ç¡®ä¿å¼€å‘è€…å·¥å…·å’ŒCIå·¥å…·çš„æ„å»ºè¡Œä¸ºä¸€è‡´ï¼Œå»ºè®®åœ¨ `project.config.json` ä¸­é…ç½®ï¼š

```json
{
  "setting": {
    "packNpmManually": false,
    "packNpmRelationList": [
      {
        "packageJsonPath": "./package.json",
        "miniprogramNpmDistDir": "./"
      }
    ]
  }
}
```

è¿™æ ·é…ç½®åï¼š
- **å¼€å‘è€…å·¥å…·**: ä¼šåœ¨é¡¹ç›®æ ¹ç›®å½•ç”Ÿæˆ `miniprogram_npm`
- **CIå·¥å…·**: ä¹Ÿä¼šåœ¨é¡¹ç›®æ ¹ç›®å½•ç”Ÿæˆ `miniprogram_npm`
- ä¸¤è€…è¡Œä¸ºä¿æŒä¸€è‡´

### æ„å»ºä½ç½®è¯´æ˜

- `miniprogramNpmDistDir: "./"` - æ„å»ºåˆ°é¡¹ç›®æ ¹ç›®å½•
- `miniprogramNpmDistDir: "./miniprogram"` - æ„å»ºåˆ°miniprogramç›®å½•ä¸‹

æ ¹æ®ä½ çš„é¡¹ç›®ç»“æ„é€‰æ‹©åˆé€‚çš„é…ç½®ã€‚

## è®¸å¯è¯

MIT
